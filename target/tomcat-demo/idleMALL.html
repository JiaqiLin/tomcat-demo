<!doctype html>
<html lang="en" style="height: auto">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="no-referrer">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/idleMALL.css">
    <link href="font.css" rel="stylesheet">
    <title>闲置商城-校园易</title>
</head>
<body  style="background-repeat:no-repeat;background-attachment:fixed;background-image:url(./images/bd.png);height: auto">
<!-- Option 1: Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
<script src="./js/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://code.jquery.com/jquery.js"></script>

<div id="idleMALL">
    <!--卖家联系方式框-->
    <div class="modal" tabindex="-1" id="sponsorContact">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div v-if="ifDeleted===false">
                    <div class="modal-header">
                        <h5 class="modal-title">卖家联系方式</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>电话：{{sponsorContact.phoneNumber}}<br>
                            QQ：{{sponsorContact.qQ}}<br>
                            微信：{{sponsorContact.weChat}}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" v-on:click="closeSponsorContactDetails()" class="btn btn-secondary" data-bs-dismiss="modal">我知道了</button>

                    </div>
                </div>
                <div v-else>
                    <div class="modal-header">
                        <h5 class="modal-title">提示</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>宝贝已下架...</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" v-on:click="closeSponsorContactDetails()" class="btn btn-secondary" data-bs-dismiss="modal">我知道了</button>

                    </div>
                </div>

            </div>
        </div>
    </div>
    <!--登出提示框-->
    <div class="modal" tabindex="-1" id="exit">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">提示</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确认退出吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" v-on:click="exit" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>

            </div>
        </div>
    </div>
    <!--导航栏-->
    <nav class="navbar navbar-expand-lg navbar-light bg-warning fixed-top">
        <div class="container-fluid">
            <!--主标-->
            <a class="navbar-brand mark" href="Home.html">校园易</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <!--前部分-->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="idleMALL.html?searchContent=">闲置商城</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="demandMALL.html">需求商城</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            发布
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="uploadIdle.html">发布闲置</a></li>
                            <li><a class="dropdown-item" href="uploadDemand.html">发布需求</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">发布规则</a></li>
                        </ul>
                    </li>
                </ul>

                <!--后部分-->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="selfInfo.html" class="nav-link" aria-current="page">{{user.userName}}</a>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="selfDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            我的小易
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="myIdles.html">我的闲置</a></li>
                            <li><a class="dropdown-item" href="myDemands.html">我的需求</a></li>
                            <li><a class="dropdown-item" href="myMessages.html">我的消息</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="selfInfo.html">个人信息</a></li>
                            <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exit">退出登录</a></li>
                        </ul>
                    </li>

                </ul>
            </div>
        </div>
    </nav>


    <!--搜索框-->
    <div class="container" style="margin-top:7%">
        <div class="row clearfix">
            <div class="col-3 column">
                <h1 class="headline">闲置商城</h1>
            </div>
            <div class="col-7 column">
                <div class="input-group mt-4">
                    <input type="text" name="search" class="form-control" placeholder="请输入类型" v-model="searchContent">
                    <button class="btn btn-warning btn-search" v-on:click="search" type="button">搜索</button>
                </div>
            </div>
            <div class="col-1"></div>
        </div>

        <br><br>
    </div>

    <!--  闲置展示-->
    <div class="container">
        <div v-if="ifSearch===false">
            <h2><mark>暂无闲置...</mark></h2>
        </div>
        <div class="row">
            <div v-for="(idle,index) in idles" key="index" class="col-sm-4">
                <div class="card myCard">
                    <div class="card-body">
                        <div class="row g-0">
                            <div class="col-md-5">
                                <img class="cardIMG" alt="图片未加载" :src="'http://localhost:8080'+idle.image1" />
                            </div>
                            <div class="col-md-7">
                                <div class="card-body cardBODY">
                                    <h5 class="card-title title">{{idle.brief}}</h5>
                                    <p class="card-text">
                                        价格：{{idle.price}}元<br>
                                        <small>{{idle.releaseTime}}</small><br>

                                    </p>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sponsorContact" v-on:click="showSponsorContactDetails(idle.idleNumber)">我想要</button>
                                    <a class="btn" :href="'idleDisplay.html?idleNumber='+idle.idleNumber">了解更多</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    new Vue({
        el: "#idleMALL",
        data: {
            idles: [],
            sponsorContact:{},
            //是否删除了
            ifDeleted:false,
            //查询内容
            searchContent:"",
            //是否查询到
            ifSearch:true,
            //用户ID
            currentUserID:"",
            //用户名
            user:"",
            verifyStatus:"",
            page: { // 分页参数，字段名按照后端给出的接口文档来
                    currentPage: 1, // 当前页数，从第一页开始
                    pageSize: 9 // 一页要展现的数据数，按照高度来，本项目中是一页9个
                },
            totalPages: "", // 记录接口返回数据的总页数
        },

        //闲置商城初始化页面后
        mounted(){
            //获取用户名
            //获取session里的账号
            let user = sessionStorage.getItem("userID");
            if (user != null) {
                // 将JSON格式的对象解析为js对象
                this.currentUserID= JSON.parse(user);
                axios({
                    method:"GET",
                    url:"http://localhost:8080/tomcat_demo_war/userServlet/getUserByUserID?userID="+this.currentUserID
                }).then(resp=>{
                    this.user=resp.data;
                    this.verifyStatus=this.user.verifyStatus;
                })
            }
            else {
                //没登录跳转登录页面
                window.location.href="login.html";
            }

            //获取从首页跳转过来的查询语句
            let getUrl = window.location.href;
            let getParametersString = getUrl.split('?')[1];
            let getParameters = new URLSearchParams('?'+getParametersString) ; //将参数放在URLSearchParams函数中
            this.searchContent = getParameters.get('searchContent').toString();

            //监听滑动事件
            window.addEventListener("scroll",this.handleScroll,true);

            //初始化页面时先进行一次查找，这里不知道为什么没法触发滑到底部函数，所以手动查找
            axios({
                method:"GET",
                url:"http://localhost:8080/tomcat_demo_war/idleServlet/getReleasedIdlesByPage?keyword="+this.searchContent+"&currentPage=1&pageSize=9"
            }).then(resp=>{
                const result=resp.data.rows;
                this.totalPages=Math.ceil(parseInt(resp.data.totalCount)/parseInt(this.page.pageSize));
                this.idles=this.idles.concat(result);
                result.length===0?this.ifSearch=false:this.ifSearch=true;
            })
            },

        methods: {
            //分页方法
            getIdles:function(type){
                axios({
                    method:"GET",
                    url:"http://localhost:8080/tomcat_demo_war/idleServlet/getReleasedIdlesByPage?keyword="+this.searchContent+"&currentPage="+this.page.currentPage+"&pageSize="+this.page.pageSize
                }).then(resp=>{
                    //获取查找闲置数据
                    const result=resp.data.rows;
                    //获取闲置总页数
                    this.totalPages=Math.ceil(parseInt(resp.data.totalCount)/parseInt(this.page.pageSize));
                    type==='1'?this.idles=this.idles.concat(result):this.idles=result;
                    if(type==='2'){
                        result.length===0?this.ifSearch=false:this.ifSearch=true;
                    }
                })
            },
            //点击我可以提供按钮
            showSponsorContactDetails: function (idleNumber) {
                //没认证，直接跳转认证页
                if(this.verifyStatus!==1){
                    window.location.href="identityManagement.html";
                }
                axios({
                    method: "GET",
                    url: "http://localhost:8080/tomcat_demo_war/userServlet/getUserByIdleNumber?idleNumber=" + idleNumber
                }).then(resp => {
                    this.sponsorContact = resp.data;  //接收
                    //商品未下架
                    this.ifDeleted = JSON.stringify(this.sponsorContact) == '{}';
                })

            },
            //关闭卖家信息
            closeSponsorContactDetails: function () {
                // this.reload();    //重新加载页面


            },
            //查找需求
            search: function () {
                this.page={
                    currentPage:1,
                    pageSize:9
                }
                if(this.ifSearch!==true)
                {
                    document.body.scrollTop=0;
                }
                this.getIdles('2');
            },
            //滑到底部的回调函数
            handleScroll() {
                let scrollTop =
                    document.documentElement.scrollTop || document.body.scrollTop;
                // 返回该元素的像素高度，高度包含内边距（padding），不包含边框（border），外边距（margin）和滚动条
                let clientHeight =
                    document.documentElement.clientHeight || document.body.clientHeight;
                // 返回该元素的像素高度，高度包含内边距（padding），不包含外边距（margin）、边框（border）
                let scrollHeight =
                    document.documentElement.scrollHeight || document.body.scrollHeight;
                let numHeight = scrollTop + clientHeight;
                //滑到底部
                if (scrollHeight > clientHeight && numHeight > scrollHeight - 1) {
                    this.page.currentPage=parseInt(this.page.currentPage)+1;
                    if(this.page.currentPage>parseInt(this.totalPages)){
                        return false;
                    }
                    this.getIdles('1');

                }
        },
            //登出
            exit:function () {
                sessionStorage.removeItem("userID");
                window.location.href="Home.html";
            }
    },
        //销毁
        destroyed() {
            window.removeEventListener('scroll', this.handleScroll);}
        })
</script>


</body>
</html>
